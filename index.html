<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>NIC Forms Analytics Dashboard</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { background:#f4f6f9; }
.card { margin-bottom: 20px; }
.summary { border-left:5px solid #0d6efd; }
</style>
</head>

<body>

<div class="container mt-4">
  <h3>NIC Forms – Card Issuance Analytics Dashboard</h3>

  <!-- TOTAL -->
  <div class="card p-4 text-center summary">
    <h5>Total Cards Issued</h5>
    <h2 id="totalCards">0</h2>
  </div>

  <div class="row mt-3">
    <div class="col-md-6">
      <div class="card p-3">
        <h5>Cards Issued vs Area</h5>
        <canvas id="areaChart"></canvas>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card p-3">
        <h5>Top 10 VLEs by Cards Issued</h5>
        <canvas id="vleChart"></canvas>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6">
      <div class="card p-3">
        <h5>This Week – Cards Issued per Date</h5>
        <canvas id="weekChart"></canvas>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card p-3">
        <h5>This Month – Cards Issued per Week</h5>
        <canvas id="monthChart"></canvas>
      </div>
    </div>
  </div>

  <div class="card p-3">
    <h5>Top 10 Card Issuers</h5>
    <table class="table table-bordered table-sm">
      <thead class="table-light">
        <tr>
          <th>VLE Name</th>
          <th>Cards Issued</th>
          <th>Area</th>
        </tr>
      </thead>
      <tbody id="topTable"></tbody>
    </table>
  </div>
</div>

<script>
fetch("getData.php")
.then(res => res.json())
.then(data => {
  const records = data.output || [];
  let total = 0;

  const area = {}, vle = {}, week = {}, month = {
    "Week 1":0,"Week 2":0,"Week 3":0,"Week 4":0,"Week 5":0
  };

  const today = new Date();
  const weekStart = new Date(today);
  weekStart.setDate(today.getDate() - today.getDay());

  records.forEach(r => {
    const cards = Number(r["TOTAL NUMBER OF THE CARD ISSUE TODAY "] || 0);
    const areaName = r["Select"] || "Unknown";
    const vleName = r["ENTER YOUR NAME "] || "Unknown";
    const d = new Date(r["Date Field"]);

    total += cards;
    area[areaName] = (area[areaName] || 0) + cards;

    if(!vle[vleName]) vle[vleName] = {cards:0, area:areaName};
    vle[vleName].cards += cards;

    if(d >= weekStart){
      const key = d.toISOString().split("T")[0];
      week[key] = (week[key] || 0) + cards;
    }

    if(d.getMonth() === today.getMonth()){
      const w = "Week " + Math.ceil(d.getDate()/7);
      month[w] += cards;
    }
  });

  document.getElementById("totalCards").innerText = total;

  new Chart(areaChart, {
    type:"bar",
    data:{labels:Object.keys(area),datasets:[{label:"Cards",data:Object.values(area)}]}
  });

  const top = Object.entries(vle).sort((a,b)=>b[1].cards-a[1].cards).slice(0,10);
  new Chart(vleChart,{
    type:"bar",
    data:{labels:top.map(v=>v[0]),datasets:[{label:"Cards",data:top.map(v=>v[1].cards)}]}
  });

  new Chart(weekChart,{
    type:"line",
    data:{labels:Object.keys(week),datasets:[{label:"Cards",data:Object.values(week)}]}
  });

  new Chart(monthChart,{
    type:"bar",
    data:{labels:Object.keys(month),datasets:[{label:"Cards",data:Object.values(month)}]}
  });

  const table = document.getElementById("topTable");
  top.forEach(v=>{
    table.innerHTML += `<tr><td>${v[0]}</td><td>${v[1].cards}</td><td>${v[1].area}</td></tr>`;
  });
});
</script>

</body>
</html>
